# 构建与部署指南

本项目使用Docker容器化技术进行前后端构建和部署。构建脚本(`build.sh`)提供了自动化构建、打包和部署服务。

## 构建脚本功能

构建脚本(`build.sh`)提供以下功能：

1. **自动构建前后端Docker镜像**
   - 使用当前日期作为镜像标签 (yyyyddmm格式)
   - 支持构建缓存优化，加速重复构建
   - 构建失败时自动重试（最多3次）

2. **将镜像打包并传输到远程服务器**
   - 保存镜像为tar文件
   - 通过scp传输到远程服务器
   - 在远程服务器上加载镜像

3. **错误处理和日志记录**
   - 详细的构建日志保存在`build_logs`目录
   - 完善的错误处理和状态报告

## 使用方法

### 基本用法

```bash
# 使用构建缓存(推荐，大幅提高构建速度)
./build.sh

# 禁用构建缓存(完全重新构建)
./build.sh --no-cache
```

### 命令行选项

| 选项 | 说明 |
|------|------|
| `--no-cache` | 禁用Docker构建缓存，强制完全重新构建 |
| `--help` | 显示帮助信息 |

## 缓存策略说明

### 前端构建缓存优化

前端Dockerfile采用了多层构建策略以优化缓存：

1. 先复制并安装依赖(`package.json`)
2. 复制不常变化的资源文件和配置
3. 最后复制所有源代码
4. 创建必要的样式文件
5. 执行构建

这确保在只修改源代码时，依赖安装步骤可以使用缓存，大大缩短构建时间。

### 后端构建缓存优化

后端Dockerfile同样采用多层构建策略：

1. 先复制`requirements.txt`
2. 安装Python依赖
3. 复制配置文件
4. 最后复制所有源代码

## 已解决的问题

构建脚本和Dockerfile已解决以下问题：

1. **前端Angular构建问题**
   - 样式文件缺失问题
   - Google字体内联失败
   - TypeScript类型声明问题

2. **构建过程稳定性**
   - 网络问题导致的构建失败
   - 依赖安装超时
   - 代理连接问题

## 注意事项

1. 确保已配置到远程服务器(`hl-app`)的SSH免密登录
2. 远程服务器需要安装Docker
3. 首次构建时间较长，后续增量构建会更快 